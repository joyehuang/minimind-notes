"""
ğŸŒ€ RoPE ä»é›¶ç†è§£ - ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ç¼–ç 
==================================================

è¿™ä¸ªç¨‹åºå¸®ä½ ç†è§£ï¼š
1. Attention ä¸ºä»€ä¹ˆæ˜¯"æ’åˆ—ä¸å˜"çš„
2. ä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ç¼–ç 
3. RoPE çš„æ ¸å¿ƒæ€æƒ³
"""

import torch
import torch.nn.functional as F


# ============================================================
# å®éªŒ 1: Attention çš„"æ’åˆ—ä¸å˜æ€§"é—®é¢˜
# ============================================================
def experiment_permutation_invariance():
    print("="*70)
    print("ğŸ”´ å®éªŒ 1: Attention çš„æ’åˆ—ä¸å˜æ€§é—®é¢˜")
    print("="*70)

    # æ¨¡æ‹Ÿä¸‰ä¸ªè¯çš„åµŒå…¥å‘é‡
    # å‡è®¾è¿™æ˜¯ ["æˆ‘", "å–œæ¬¢", "ä½ "] çš„è¯å‘é‡
    sentence1 = torch.tensor([
        [1.0, 0.0, 0.0],  # "æˆ‘"
        [0.0, 1.0, 0.0],  # "å–œæ¬¢"
        [0.0, 0.0, 1.0],  # "ä½ "
    ]).unsqueeze(0)  # [batch_size=1, seq_len=3, dim=3]

    # æ‰“ä¹±é¡ºåºï¼š["ä½ ", "å–œæ¬¢", "æˆ‘"]
    sentence2 = torch.tensor([
        [0.0, 0.0, 1.0],  # "ä½ "
        [0.0, 1.0, 0.0],  # "å–œæ¬¢"
        [1.0, 0.0, 0.0],  # "æˆ‘"
    ]).unsqueeze(0)

    print("\nå¥å­ 1: [æˆ‘, å–œæ¬¢, ä½ ]")
    print(sentence1.squeeze(0))

    print("\nå¥å­ 2: [ä½ , å–œæ¬¢, æˆ‘]")
    print(sentence2.squeeze(0))

    # ç®€åŒ–çš„ Attention è®¡ç®—ï¼ˆåªç”¨ QÂ·K^Tï¼‰
    # æ³¨æ„ï¼šè¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼ŒQ=K=V=è¾“å…¥æœ¬èº«
    def simple_attention_scores(x):
        # x: [1, seq_len, dim]
        # è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°: Q @ K^T
        scores = x @ x.transpose(-2, -1)  # [1, 3, 3]
        return scores.squeeze(0)  # [3, 3]

    scores1 = simple_attention_scores(sentence1)
    scores2 = simple_attention_scores(sentence2)

    print("\nå¥å­ 1 çš„æ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µ:")
    print(scores1)

    print("\nå¥å­ 2 çš„æ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µ:")
    print(scores2)

    print("\n" + "="*70)
    print("âŒ é—®é¢˜ï¼šè™½ç„¶è¯åºä¸åŒï¼Œä½†æ³¨æ„åŠ›æ¨¡å¼ï¼ˆçŸ©é˜µçš„æ•°å€¼ï¼‰")
    print("   è¢«æ‰“ä¹±äº†ï¼æ¨¡å‹æ— æ³•åŒºåˆ† 'æˆ‘å–œæ¬¢ä½ ' å’Œ 'ä½ å–œæ¬¢æˆ‘'")
    print("="*70)


# ============================================================
# å®éªŒ 2: æ·»åŠ ç®€å•çš„ä½ç½®ç¼–ç 
# ============================================================
def experiment_with_position():
    print("\n\n")
    print("="*70)
    print("ğŸŸ¢ å®éªŒ 2: æ·»åŠ ä½ç½®ä¿¡æ¯å")
    print("="*70)

    # åŒæ ·çš„è¯å‘é‡
    sentence1 = torch.tensor([
        [1.0, 0.0, 0.0],  # "æˆ‘"
        [0.0, 1.0, 0.0],  # "å–œæ¬¢"
        [0.0, 0.0, 1.0],  # "ä½ "
    ])

    sentence2 = torch.tensor([
        [0.0, 0.0, 1.0],  # "ä½ "
        [0.0, 1.0, 0.0],  # "å–œæ¬¢"
        [1.0, 0.0, 0.0],  # "æˆ‘"
    ])

    # æ·»åŠ ç®€å•çš„ä½ç½®ç¼–ç ï¼ˆä½ç½®0, 1, 2ï¼‰
    # è¿™é‡Œç”¨æœ€ç®€å•çš„æ–¹æ³•ï¼šæŠŠä½ç½®ç¼–å·ä¹˜ä»¥ä¸€ä¸ªå°æ•°åŠ åˆ°å‘é‡ä¸Š
    position_ids = torch.tensor([0.1, 0.2, 0.3]).unsqueeze(1)  # [3, 1]

    # åŠ ä¸Šä½ç½®ä¿¡æ¯
    sentence1_with_pos = sentence1 + position_ids
    sentence2_with_pos = sentence2 + position_ids

    print("\nå¥å­ 1 + ä½ç½®ç¼–ç : [æˆ‘(ä½ç½®0), å–œæ¬¢(ä½ç½®1), ä½ (ä½ç½®2)]")
    print(sentence1_with_pos)

    print("\nå¥å­ 2 + ä½ç½®ç¼–ç : [ä½ (ä½ç½®0), å–œæ¬¢(ä½ç½®1), æˆ‘(ä½ç½®2)]")
    print(sentence2_with_pos)

    def simple_attention_scores(x):
        scores = x @ x.T
        return scores

    scores1 = simple_attention_scores(sentence1_with_pos)
    scores2 = simple_attention_scores(sentence2_with_pos)

    print("\nå¥å­ 1 çš„æ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µ:")
    print(scores1)

    print("\nå¥å­ 2 çš„æ³¨æ„åŠ›åˆ†æ•°çŸ©é˜µ:")
    print(scores2)

    print("\n" + "="*70)
    print("âœ… ç°åœ¨çŸ©é˜µä¸åŒäº†ï¼æ¨¡å‹å¯ä»¥åŒºåˆ†ä¸åŒçš„è¯åº")
    print("="*70)


# ============================================================
# å®éªŒ 3: RoPE çš„æ ¸å¿ƒæ€æƒ³ - æ—‹è½¬
# ============================================================
def experiment_rope_intuition():
    print("\n\n")
    print("="*70)
    print("ğŸŒ€ å®éªŒ 3: RoPE çš„æ ¸å¿ƒæ€æƒ³ - æ—‹è½¬å‘é‡")
    print("="*70)

    print("\næƒ³è±¡ä¸€ä¸ª 2D å‘é‡åœ¨å¹³é¢ä¸Šæ—‹è½¬ï¼š")
    print("""
        y
        |
        |  â— (x, y) åŸå§‹å‘é‡
        | /
        |/_____ x

    æ—‹è½¬ Î¸ è§’åº¦åï¼š
        y
        |
        |      â— (x', y') æ—‹è½¬åçš„å‘é‡
        |    /
        |  /
        |/_____ x
    """)

    # åˆ›å»ºä¸€ä¸ªç®€å•çš„ 2D å‘é‡
    vector = torch.tensor([1.0, 0.0])  # æŒ‡å‘å³è¾¹çš„å•ä½å‘é‡

    print(f"\nåŸå§‹å‘é‡: {vector}")
    print(f"  è¿™ä¸ªå‘é‡æŒ‡å‘ â†’ï¼ˆä¸œï¼‰æ–¹å‘")

    # æ—‹è½¬çŸ©é˜µå…¬å¼ï¼š
    # [cos(Î¸)  -sin(Î¸)] [x]
    # [sin(Î¸)   cos(Î¸)] [y]

    def rotate_vector(v, angle_degrees):
        """æ—‹è½¬ä¸€ä¸ª 2D å‘é‡"""
        angle = torch.tensor(angle_degrees * 3.14159 / 180)  # è½¬æ¢ä¸ºå¼§åº¦
        cos = torch.cos(angle)
        sin = torch.sin(angle)

        rotation_matrix = torch.tensor([
            [cos, -sin],
            [sin,  cos]
        ])

        return rotation_matrix @ v

    # æ—‹è½¬ä¸åŒè§’åº¦
    for angle in [0, 45, 90, 180]:
        rotated = rotate_vector(vector, angle)
        print(f"\næ—‹è½¬ {angle:3d}Â°: {rotated}")

        if angle == 0:
            print("  â†’ æ–¹å‘ï¼ˆä¸œï¼‰")
        elif angle == 45:
            print("  â†— æ–¹å‘ï¼ˆä¸œåŒ—ï¼‰")
        elif angle == 90:
            print("  â†‘ æ–¹å‘ï¼ˆåŒ—ï¼‰")
        elif angle == 180:
            print("  â† æ–¹å‘ï¼ˆè¥¿ï¼‰")

    print("\n" + "="*70)
    print("ğŸ’¡ RoPE çš„å…³é”®æ€æƒ³:")
    print("  - ä½ç½® 0 â†’ æ—‹è½¬ 0Â°")
    print("  - ä½ç½® 1 â†’ æ—‹è½¬ Î¸Â°")
    print("  - ä½ç½® 2 â†’ æ—‹è½¬ 2Î¸Â°")
    print("  - ä½ç½® 3 â†’ æ—‹è½¬ 3Î¸Â°")
    print("  ...")
    print("\n  è¿™æ ·ï¼Œç›¸å¯¹ä½ç½® = ç›¸å¯¹æ—‹è½¬è§’åº¦ï¼")
    print("="*70)


# ============================================================
# å®éªŒ 4: ç›¸å¯¹ä½ç½®çš„é­”æ³•
# ============================================================
def experiment_relative_position():
    print("\n\n")
    print("="*70)
    print("âœ¨ å®éªŒ 4: RoPE å¦‚ä½•è‡ªåŠ¨ç¼–ç ç›¸å¯¹ä½ç½®")
    print("="*70)

    print("\nå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªè¯ï¼š")
    print("  è¯ A åœ¨ä½ç½® 5")
    print("  è¯ B åœ¨ä½ç½® 8")
    print("  ç›¸å¯¹è·ç¦» = 8 - 5 = 3")

    # åˆ›å»ºä¸¤ä¸ªç®€å•å‘é‡
    word_a = torch.tensor([1.0, 0.0])
    word_b = torch.tensor([0.8, 0.6])  # ä¸åŒçš„å‘é‡

    # å‡è®¾æ¯ä¸ªä½ç½®æ—‹è½¬ 30 åº¦
    theta = 30

    def rotate_vector(v, angle_degrees):
        angle = torch.tensor(angle_degrees * 3.14159 / 180)
        cos = torch.cos(angle)
        sin = torch.sin(angle)
        rotation_matrix = torch.tensor([[cos, -sin], [sin, cos]])
        return rotation_matrix @ v

    # åº”ç”¨ RoPEï¼šæ—‹è½¬åˆ°å„è‡ªçš„ä½ç½®
    word_a_pos5 = rotate_vector(word_a, 5 * theta)  # ä½ç½® 5
    word_b_pos8 = rotate_vector(word_b, 8 * theta)  # ä½ç½® 8

    print(f"\nè¯ A åœ¨ä½ç½® 5ï¼ˆæ—‹è½¬ {5*theta}Â°ï¼‰: {word_a_pos5}")
    print(f"è¯ B åœ¨ä½ç½® 8ï¼ˆæ—‹è½¬ {8*theta}Â°ï¼‰: {word_b_pos8}")

    # è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ï¼ˆç‚¹ç§¯ï¼‰
    attention_score = (word_a_pos5 @ word_b_pos8).item()
    print(f"\næ³¨æ„åŠ›åˆ†æ•°ï¼ˆè¯AÂ·è¯Bï¼‰: {attention_score:.4f}")

    print("\n" + "-"*70)
    print("ğŸ” å…³é”®è§‚å¯Ÿï¼š")
    print("-"*70)

    # ç°åœ¨æŠŠä¸¤ä¸ªè¯éƒ½å‘å‰ç§»åŠ¨ï¼ˆæ¯”å¦‚éƒ½å‡å»ä½ç½®2ï¼‰
    # ç›¸å¯¹è·ç¦»è¿˜æ˜¯ 3ï¼
    print("\nå¦‚æœä¸¤ä¸ªè¯éƒ½å¾€å‰ç§»åŠ¨ 2 ä¸ªä½ç½®ï¼š")
    print("  è¯ A: ä½ç½® 5 â†’ ä½ç½® 3")
    print("  è¯ B: ä½ç½® 8 â†’ ä½ç½® 6")
    print("  ç›¸å¯¹è·ç¦»è¿˜æ˜¯ = 6 - 3 = 3")

    word_a_pos3 = rotate_vector(word_a, 3 * theta)  # ä½ç½® 3
    word_b_pos6 = rotate_vector(word_b, 6 * theta)  # ä½ç½® 6

    attention_score2 = (word_a_pos3 @ word_b_pos6).item()
    print(f"\næ–°çš„æ³¨æ„åŠ›åˆ†æ•°: {attention_score2:.4f}")
    print(f"ä¹‹å‰çš„æ³¨æ„åŠ›åˆ†æ•°: {attention_score:.4f}")
    print(f"\nâœ… åˆ†æ•°å‡ ä¹ç›¸åŒï¼å› ä¸ºç›¸å¯¹ä½ç½®ï¼ˆç›¸å¯¹æ—‹è½¬è§’åº¦ï¼‰æ²¡å˜ï¼")

    print("\n" + "="*70)
    print("ğŸ¯ è¿™å°±æ˜¯ RoPE çš„é­”æ³•ï¼š")
    print("  é€šè¿‡æ—‹è½¬ï¼Œè‡ªåŠ¨å®ç°äº†ç›¸å¯¹ä½ç½®ç¼–ç ï¼")
    print("="*70)


# ============================================================
# æ€»ç»“
# ============================================================
def summary():
    print("\n\n")
    print("="*70)
    print("ğŸ“š æ€»ç»“ï¼šRoPE æ ¸å¿ƒæ€æƒ³")
    print("="*70)

    print("""
1ï¸âƒ£  é—®é¢˜ï¼šAttention æ˜¯æ’åˆ—ä¸å˜çš„
    â†’ æ— æ³•åŒºåˆ† "æˆ‘å–œæ¬¢ä½ " å’Œ "ä½ å–œæ¬¢æˆ‘"

2ï¸âƒ£  è§£å†³ï¼šéœ€è¦ä½ç½®ç¼–ç 
    â†’ å‘Šè¯‰æ¨¡å‹æ¯ä¸ªè¯åœ¨å“ªä¸ªä½ç½®

3ï¸âƒ£  RoPE çš„æ–¹æ³•ï¼šæ—‹è½¬å‘é‡
    â†’ ä½ç½® i çš„å‘é‡æ—‹è½¬ iÃ—Î¸ åº¦
    â†’ ç›¸å¯¹ä½ç½® = ç›¸å¯¹æ—‹è½¬è§’åº¦ï¼ˆè‡ªåŠ¨ï¼ï¼‰

4ï¸âƒ£  ä¼˜ç‚¹ï¼š
    âœ… è‡ªç„¶åŒ…å«ç›¸å¯¹ä½ç½®ä¿¡æ¯
    âœ… è®¡ç®—é«˜æ•ˆï¼ˆé¢„è®¡ç®— cos/sinï¼‰
    âœ… æ”¯æŒé•¿åº¦å¤–æ¨ï¼ˆYaRNï¼‰

5ï¸âƒ£  åœ¨ MiniMind ä¸­ï¼š
    - æ¯ä¸ª Attention è®¡ç®—å‰éƒ½ä¼šåº”ç”¨ RoPE
    - æ—‹è½¬é¢‘ç‡é¢„å…ˆè®¡ç®—å¥½ï¼ˆfreqs_cos, freqs_sinï¼‰
    - ä»£ç ä½ç½®: model/model_minimind.py:108-137
    """)

    print("="*70)


# ============================================================
# è¿è¡Œæ‰€æœ‰å®éªŒ
# ============================================================
if __name__ == "__main__":
    print("\nğŸŒ€ RoPE ä»é›¶ç†è§£ - åŸºç¡€æ¦‚å¿µ\n")

    # å®éªŒ 1: å±•ç¤ºé—®é¢˜
    experiment_permutation_invariance()

    # å®éªŒ 2: ç®€å•çš„è§£å†³æ–¹æ¡ˆ
    experiment_with_position()

    # å®éªŒ 3: RoPE çš„æ—‹è½¬æ€æƒ³
    experiment_rope_intuition()

    # å®éªŒ 4: ç›¸å¯¹ä½ç½®çš„é­”æ³•
    experiment_relative_position()

    # æ€»ç»“
    summary()

    print("\n\nğŸ’­ æ€è€ƒé¢˜:")
    print("="*70)
    print("""
1. å¦‚æœä¸ç”¨ä½ç½®ç¼–ç ï¼ŒTransformer èƒ½å·¥ä½œå—ï¼Ÿ
   â†’ èƒ½å·¥ä½œï¼Œä½†æ— æ³•ç†è§£è¯åºï¼Œæ•ˆæœå¾ˆå·®

2. ä¸ºä»€ä¹ˆ RoPE èƒ½å¤–æ¨åˆ°æ›´é•¿çš„åºåˆ—ï¼Ÿ
   â†’ å› ä¸ºå®ƒç”¨çš„æ˜¯æ—‹è½¬è§’åº¦ï¼Œåªè¦è§’åº¦ç®—æ³•åˆç†ï¼ˆYaRNï¼‰ï¼Œ
      å¯ä»¥æ¨å¹¿åˆ°è®­ç»ƒæ—¶æ²¡è§è¿‡çš„é•¿åº¦

3. RoPE åªæ—‹è½¬ Q å’Œ Kï¼Œä¸ºä»€ä¹ˆä¸æ—‹è½¬ Vï¼Ÿ
   â†’ å› ä¸ºä½ç½®ä¿¡æ¯åªéœ€è¦å½±å“"åŒ¹é…åº¦"ï¼ˆQÂ·Kï¼‰ï¼Œ
      ä¸éœ€è¦å½±å“"å†…å®¹"ï¼ˆVï¼‰
    """)
    print("="*70)
