"""
ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦å¤šä¸ªé¢‘ç‡ï¼Ÿåªç”¨ä¸€ä¸ªè¶…ä½é¢‘ç‡ä¸è¡Œå—ï¼Ÿ
=====================================================

è¿™ä¸ªç¨‹åºæ¼”ç¤ºï¼š
1. å•ä¸€ä½é¢‘ç‡çš„ç²¾åº¦é—®é¢˜
2. å¤šé¢‘ç‡çš„ä¼˜åŠ¿
"""

import torch
import math


# ============================================================
# å®éªŒ 1: åªç”¨ä¸€ä¸ªè¶…ä½é¢‘ç‡
# ============================================================
def experiment_single_low_frequency():
    print("="*70)
    print("ğŸ”´ å®éªŒ 1: åªç”¨ä¸€ä¸ªè¶…ä½é¢‘ç‡")
    print("="*70)

    # ä½¿ç”¨ä¸€ä¸ªè¶…çº§æ…¢çš„é¢‘ç‡ï¼Œèƒ½è¦†ç›– 100ä¸‡ä¸ª token
    # é¢‘ç‡ = 2Ï€ / 1000000  (æ¯ 100ä¸‡ä¸ªtokenè½¬ä¸€åœˆ)
    freq = 2 * math.pi / 1000000

    print(f"\né¢‘ç‡: {freq:.2e}")
    print(f"å«ä¹‰: æ¯ 1,000,000 ä¸ªtokenè½¬360åº¦\n")

    # åˆ›å»ºä¸€ä¸ªç®€å•çš„ 2D å‘é‡
    vector = torch.tensor([1.0, 0.0])

    def rotate_vector(v, angle):
        """æ—‹è½¬ä¸€ä¸ª 2D å‘é‡"""
        cos = math.cos(angle)
        sin = math.sin(angle)
        rotation_matrix = torch.tensor([[cos, -sin], [sin, cos]])
        return rotation_matrix @ v

    # æµ‹è¯•ç›¸é‚»çš„å‡ ä¸ªä½ç½®
    positions = [0, 1, 2, 3, 10, 100]

    print("ä½ç½®\tæ—‹è½¬è§’åº¦\t\tå‘é‡xåˆ†é‡\t\tå‘é‡yåˆ†é‡")
    print("-"*70)

    vectors = {}
    for pos in positions:
        angle = pos * freq
        rotated = rotate_vector(vector, angle)
        vectors[pos] = rotated

        degree = (angle * 180 / math.pi) % 360
        print(f"{pos:4d}\t{degree:8.6f}Â°\t\t{rotated[0].item():.15f}\t{rotated[1].item():.15f}")

    print("\n" + "="*70)
    print("ğŸ” å…³é”®é—®é¢˜ï¼šä½ç½® 0 å’Œä½ç½® 1 çš„å‘é‡æœ‰å¤šç›¸ä¼¼ï¼Ÿ")
    print("="*70)

    # è®¡ç®—ä½ç½® 0 å’Œä½ç½® 1 çš„ç›¸ä¼¼åº¦ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ = ç‚¹ç§¯ï¼‰
    similarity_0_1 = (vectors[0] @ vectors[1]).item()
    similarity_0_100 = (vectors[0] @ vectors[100]).item()

    print(f"\nä½ç½®0 å’Œ ä½ç½®1 çš„ç›¸ä¼¼åº¦: {similarity_0_1:.15f}")
    print(f"ä½ç½®0 å’Œ ä½ç½®100 çš„ç›¸ä¼¼åº¦: {similarity_0_100:.15f}")

    print("\nâŒ é—®é¢˜ï¼š")
    print(f"  - ä½ç½®0å’Œ1å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼ˆç›¸ä¼¼åº¦ = {similarity_0_1:.15f} â‰ˆ 1ï¼‰")
    print(f"  - æ¨¡å‹å¾ˆéš¾åŒºåˆ†ç›¸é‚»çš„ä½ç½®ï¼")
    print(f"  - å°±åƒç”¨æ—¶é’ˆåŒºåˆ† 9:00 å’Œ 9:01ï¼Œå·®åˆ«å¤ªå°äº†")


# ============================================================
# å®éªŒ 2: æµ®ç‚¹æ•°ç²¾åº¦é™åˆ¶
# ============================================================
def experiment_floating_point_precision():
    print("\n\n")
    print("="*70)
    print("ğŸ’» å®éªŒ 2: æµ®ç‚¹æ•°ç²¾åº¦çš„é™åˆ¶")
    print("="*70)

    print("\nPyTorch é»˜è®¤ä½¿ç”¨ float32ï¼ˆå•ç²¾åº¦æµ®ç‚¹æ•°ï¼‰")
    print("float32 çš„æœ‰æ•ˆæ•°å­—çº¦ä¸º 6-7 ä½")
    print()

    # ä½¿ç”¨è¶…ä½é¢‘ç‡
    freq = 2 * math.pi / 1000000

    # ä½ç½® 0 çš„è§’åº¦
    angle_0 = 0 * freq
    # ä½ç½® 1 çš„è§’åº¦
    angle_1 = 1 * freq

    print(f"ä½ç½®0çš„è§’åº¦: {angle_0:.20f}")
    print(f"ä½ç½®1çš„è§’åº¦: {angle_1:.20f}")
    print(f"è§’åº¦å·®: {angle_1 - angle_0:.20e}")

    # è®¡ç®— cos å’Œ sin
    cos_0 = math.cos(angle_0)
    cos_1 = math.cos(angle_1)

    print(f"\ncos(ä½ç½®0): {cos_0:.15f}")
    print(f"cos(ä½ç½®1): {cos_1:.15f}")
    print(f"å·®å€¼: {abs(cos_1 - cos_0):.15e}")

    # è½¬æ¢ä¸º float32
    cos_0_f32 = torch.tensor(cos_0, dtype=torch.float32).item()
    cos_1_f32 = torch.tensor(cos_1, dtype=torch.float32).item()

    print(f"\nfloat32 ç²¾åº¦ä¸‹:")
    print(f"cos(ä½ç½®0): {cos_0_f32:.15f}")
    print(f"cos(ä½ç½®1): {cos_1_f32:.15f}")
    print(f"å·®å€¼: {abs(cos_1_f32 - cos_0_f32):.15e}")

    if cos_0_f32 == cos_1_f32:
        print("\nâŒ åœ¨ float32 ç²¾åº¦ä¸‹ï¼Œä½ç½®0å’Œä½ç½®1å®Œå…¨ç›¸åŒï¼")
        print("   æµ®ç‚¹æ•°ç²¾åº¦ä¸å¤Ÿï¼Œæ— æ³•è¡¨ç¤ºè¿™ä¹ˆå°çš„å·®åˆ«ï¼")


# ============================================================
# å®éªŒ 3: å¤šé¢‘ç‡çš„è§£å†³æ–¹æ¡ˆ
# ============================================================
def experiment_multi_frequency_solution():
    print("\n\n")
    print("="*70)
    print("ğŸŸ¢ å®éªŒ 3: å¤šé¢‘ç‡çš„è§£å†³æ–¹æ¡ˆ")
    print("="*70)

    print("\nä½¿ç”¨ 3 ä¸ªé¢‘ç‡ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™… MiniMind ç”¨ 32 ä¸ªï¼‰:")
    print("  é¢‘ç‡1ï¼ˆé«˜é¢‘ï¼‰: æ¯ 10 ä¸ªtokenè½¬ä¸€åœˆ    â†’ ç²¾ç¡®åŒºåˆ†ç›¸é‚»ä½ç½®")
    print("  é¢‘ç‡2ï¼ˆä¸­é¢‘ï¼‰: æ¯ 100 ä¸ªtokenè½¬ä¸€åœˆ   â†’ åŒºåˆ†ä¸­ç­‰è·ç¦»")
    print("  é¢‘ç‡3ï¼ˆä½é¢‘ï¼‰: æ¯ 1000 ä¸ªtokenè½¬ä¸€åœˆ  â†’ åŒºåˆ†é•¿è·ç¦»")
    print()

    freq1 = 2 * math.pi / 10
    freq2 = 2 * math.pi / 100
    freq3 = 2 * math.pi / 1000

    positions = [0, 1, 10, 100, 500]

    print("ä½ç½®\té¢‘ç‡1è§’åº¦\té¢‘ç‡2è§’åº¦\té¢‘ç‡3è§’åº¦\tç»„åˆç¼–ç ")
    print("-"*70)

    for pos in positions:
        angle1 = (pos * freq1 * 180 / math.pi) % 360
        angle2 = (pos * freq2 * 180 / math.pi) % 360
        angle3 = (pos * freq3 * 180 / math.pi) % 360

        # å°†è§’åº¦ç»„åˆæˆä¸€ä¸ª"ç¼–ç "ï¼ˆç®€åŒ–è¡¨ç¤ºï¼‰
        code = f"({angle1:.0f}Â°, {angle2:.0f}Â°, {angle3:.0f}Â°)"

        print(f"{pos:4d}\t{angle1:7.1f}Â°\t{angle2:7.1f}Â°\t{angle3:7.1f}Â°\t{code}")

    print("\nâœ… è§‚å¯Ÿ:")
    print("  - ä½ç½®0: (0Â°, 0Â°, 0Â°)")
    print("  - ä½ç½®1: (36Â°, 4Â°, 0Â°)  â† é¢‘ç‡1èƒ½æ¸…æ¥šåŒºåˆ†ï¼")
    print("  - ä½ç½®10: (0Â°, 36Â°, 4Â°) â† è™½ç„¶é¢‘ç‡1å›åˆ°åŸç‚¹ï¼Œä½†é¢‘ç‡2ä¸åŒï¼")
    print("  - æ¯ä¸ªä½ç½®éƒ½æœ‰å”¯ä¸€çš„'æŒ‡çº¹'")


# ============================================================
# å®éªŒ 4: ç›´è§‚å¯¹æ¯”
# ============================================================
def visualize_comparison():
    print("\n\n")
    print("="*70)
    print("ğŸ“Š å¯¹æ¯”æ€»ç»“")
    print("="*70)

    print("\næ–¹æ¡ˆAï¼šåªç”¨1ä¸ªè¶…ä½é¢‘ç‡")
    print("-"*70)
    print("ä¼˜ç‚¹:")
    print("  âœ… ç†è®ºä¸Šå¯ä»¥è¦†ç›–æ— é™é•¿çš„åºåˆ—")
    print()
    print("ç¼ºç‚¹:")
    print("  âŒ ç›¸é‚»ä½ç½®çš„è§’åº¦å·®å¤ªå°ï¼ˆå¾®å¼§åº¦çº§åˆ«ï¼‰")
    print("  âŒ æµ®ç‚¹æ•°ç²¾åº¦ä¸å¤Ÿï¼Œæ— æ³•è¡¨ç¤ºè¿™ä¹ˆå°çš„å·®åˆ«")
    print("  âŒ æ¨¡å‹éš¾ä»¥åŒºåˆ†ç›¸é‚»çš„è¯")
    print("  âŒ Attention åˆ†æ•°å‡ ä¹ç›¸åŒï¼Œå¤±å»ä½ç½®ä¿¡æ¯")

    print("\næ–¹æ¡ˆBï¼šå¤šé¢‘ç‡ç»„åˆï¼ˆMiniMind çš„æ–¹æ¡ˆï¼‰")
    print("-"*70)
    print("ä¼˜ç‚¹:")
    print("  âœ… é«˜é¢‘ç‡ï¼šç²¾ç¡®åŒºåˆ†ç›¸é‚»ä½ç½®ï¼ˆ1, 2, 3...ï¼‰")
    print("  âœ… ä½é¢‘ç‡ï¼šè¦†ç›–é•¿è·ç¦»ï¼ˆ1000, 10000...ï¼‰")
    print("  âœ… å¤šé¢‘ç‡ç»„åˆï¼šæ¯ä¸ªä½ç½®æœ‰å”¯ä¸€çš„'æŒ‡çº¹'")
    print("  âœ… æµ®ç‚¹æ•°ç²¾åº¦è¶³å¤Ÿè¡¨ç¤º")
    print()
    print("ç¼ºç‚¹:")
    print("  âš ï¸  éœ€è¦æ›´å¤šç»´åº¦ï¼ˆ64ç»´ â†’ 32å¯¹é¢‘ç‡ï¼‰")
    print("     ï¼ˆä½†è¿™ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸º head_dim æœ¬æ¥å°±æœ‰ 64ï¼‰")


# ============================================================
# å®éªŒ 5: æ•°å­¦è§£é‡Š
# ============================================================
def mathematical_explanation():
    print("\n\n")
    print("="*70)
    print("ğŸ”¢ æ•°å­¦è§£é‡Šï¼šä¸ºä»€ä¹ˆå•ä¸€é¢‘ç‡ä¸å¤Ÿ")
    print("="*70)

    print("""
æ ¸å¿ƒé—®é¢˜ï¼š**ä¿¡å™ªæ¯”ï¼ˆSignal-to-Noise Ratioï¼‰**

å‡è®¾æˆ‘ä»¬è¦åŒºåˆ†ä½ç½® i å’Œä½ç½® jï¼š
- ç†æƒ³æƒ…å†µï¼šcos(Î¸Â·i) å’Œ cos(Î¸Â·j) åº”è¯¥æœ‰æ˜æ˜¾å·®åˆ«
- ä½†å¦‚æœ Î¸ å¾ˆå°ï¼ˆä½é¢‘ç‡ï¼‰ï¼Œç›¸é‚»ä½ç½®çš„å·®åˆ«æ˜¯ï¼š

  Î” = cos(Î¸Â·i) - cos(Î¸Â·(i+1))
    â‰ˆ -Î¸Â·sin(Î¸Â·i)    ï¼ˆå½“ Î¸ å¾ˆå°æ—¶ï¼‰
    â‰ˆ -Î¸Â²Â·i          ï¼ˆè¿›ä¸€æ­¥è¿‘ä¼¼ï¼‰

ä¾‹å¦‚ï¼š
- å¦‚æœ Î¸ = 2Ï€/1000000 â‰ˆ 6.28e-6
- ä½ç½®1çš„å·®åˆ« â‰ˆ 3.94e-11
- **è¿™æ¯” float32 çš„ç²¾åº¦ï¼ˆ~1e-7ï¼‰è¿˜å°ï¼**

ç»“è®ºï¼š
  ä½é¢‘ç‡è™½ç„¶èƒ½"è¦†ç›–"å¾ˆé•¿çš„è·ç¦»ï¼Œ
  ä½†æ— æ³•åœ¨æµ®ç‚¹æ•°ç²¾åº¦ä¸‹"åŒºåˆ†"ç›¸é‚»ä½ç½®ï¼
    """)

    print("="*70)
    print("ğŸ’¡ ç±»æ¯”ï¼šæ˜¾å¾®é•œ vs æœ›è¿œé•œ")
    print("="*70)
    print("""
- æœ›è¿œé•œï¼ˆä½é¢‘ç‡ï¼‰ï¼šèƒ½çœ‹åˆ°è¿œå¤„çš„ä¸œè¥¿
  â†’ ä½†çœ‹ä¸æ¸…ç»†èŠ‚ï¼ˆç›¸é‚»ä½ç½®ï¼‰

- æ˜¾å¾®é•œï¼ˆé«˜é¢‘ç‡ï¼‰ï¼šèƒ½çœ‹æ¸…æ¥šç»†èŠ‚
  â†’ ä½†è§†é‡æœ‰é™ï¼ˆä¼š"è½¬åœˆå›åˆ°åŸç‚¹"ï¼‰

- å¤šç„¦è·ç»„åˆï¼ˆå¤šé¢‘ç‡ï¼‰ï¼š
  â†’ æ—¢èƒ½çœ‹æ¸…ç»†èŠ‚ï¼Œåˆèƒ½è¦†ç›–è¿œè·ç¦»ï¼
    """)


# ============================================================
# è¿è¡Œæ‰€æœ‰å®éªŒ
# ============================================================
if __name__ == "__main__":
    print("\nğŸ¤” ä¸ºä»€ä¹ˆ RoPE éœ€è¦å¤šä¸ªé¢‘ç‡ï¼Ÿ\n")

    # å®éªŒ 1: å•ä¸€ä½é¢‘ç‡çš„é—®é¢˜
    experiment_single_low_frequency()

    # å®éªŒ 2: æµ®ç‚¹æ•°ç²¾åº¦é™åˆ¶
    experiment_floating_point_precision()

    # å®éªŒ 3: å¤šé¢‘ç‡è§£å†³æ–¹æ¡ˆ
    experiment_multi_frequency_solution()

    # å®éªŒ 4: å¯¹æ¯”æ€»ç»“
    visualize_comparison()

    # å®éªŒ 5: æ•°å­¦è§£é‡Š
    mathematical_explanation()

    print("\n\n" + "="*70)
    print("ğŸ¯ æ€»ç»“")
    print("="*70)
    print("""
é—®é¢˜ï¼šä¸ºä»€ä¹ˆä¸ç”¨ä¸€ä¸ªè¶…ä½é¢‘ç‡è¦†ç›–æ‰€æœ‰ä½ç½®ï¼Ÿ

ç­”æ¡ˆï¼š
1. **æµ®ç‚¹æ•°ç²¾åº¦é™åˆ¶**
   - float32 åªæœ‰ 6-7 ä½æœ‰æ•ˆæ•°å­—
   - è¶…ä½é¢‘ç‡çš„ç›¸é‚»ä½ç½®å·®åˆ« < ç²¾åº¦ä¸‹é™
   - æ— æ³•åœ¨è®¡ç®—æœºä¸­è¡¨ç¤ºå’ŒåŒºåˆ†

2. **ä¿¡å™ªæ¯”å¤ªä½**
   - ç›¸é‚»ä½ç½®çš„è§’åº¦å·®å¤ªå°ï¼ˆå¾®å¼§åº¦ï¼‰
   - Attention åˆ†æ•°å‡ ä¹ç›¸åŒ
   - æ¨¡å‹å¤±å»ä½ç½®åŒºåˆ†èƒ½åŠ›

3. **å¤šé¢‘ç‡çš„ä¼˜åŠ¿**
   - é«˜é¢‘ï¼šåŒºåˆ†ç›¸é‚»ä½ç½®ï¼ˆ1, 2, 3...ï¼‰
   - ä½é¢‘ï¼šè¦†ç›–é•¿è·ç¦»ï¼ˆ1000, 10000...ï¼‰
   - ç»„åˆï¼šæ¯ä¸ªä½ç½®æœ‰å”¯ä¸€ä¸”å¯åŒºåˆ†çš„"ç¼–ç "

ç±»æ¯”ï¼š
  å°±åƒé’Ÿè¡¨éœ€è¦æ—¶é’ˆã€åˆ†é’ˆã€ç§’é’ˆç»„åˆï¼Œ
  ä¸èƒ½åªç”¨æ—¶é’ˆæ¥ç²¾ç¡®æŠ¥æ—¶ï¼
    """)
    print("="*70)
